<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MLX Training Interface</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Custom Styles -->
    <link href="{{ url_for('static', filename='css/styles.css') }}?v={{ cache_buster }}" rel="stylesheet">
    <!-- Chart.js (For consistent charting like monitoring tab) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js"></script>
    <!-- Plotly (Legacy support) -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <!-- Socket.IO -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>    
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-brain me-2"></i>MLX Training Interface
            </a>
            <div class="navbar-nav ms-auto">
                <button id="theme-toggle" class="btn btn-outline-light btn-sm me-3" type="button" title="Toggle dark mode">
                    <i class="fas fa-moon" id="theme-icon"></i>
                </button>
                <span class="navbar-text" id="connection-status">
                    <span class="status-indicator status-stopped"></span>
                    Connecting...
                </span>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
        <!-- Tabs -->
        <ul class="nav nav-tabs mb-4" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="training-tab" data-bs-toggle="tab" data-bs-target="#training" type="button" role="tab">
                    <i class="fas fa-play me-2"></i>Training
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="monitoring-tab" data-bs-toggle="tab" data-bs-target="#monitoring" type="button" role="tab">
                    <i class="fas fa-chart-line me-2"></i>Monitoring
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="compare-tab" data-bs-toggle="tab" data-bs-target="#compare" type="button" role="tab">
                    <i class="fas fa-balance-scale me-2"></i>Compare
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="fuse-tab" data-bs-toggle="tab" data-bs-target="#fuse" type="button" role="tab">
                    <i class="fas fa-layer-group me-2"></i>Fuse
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="quantization-tab" data-bs-toggle="tab" data-bs-target="#quantization" type="button" role="tab">
                    <i class="fas fa-compress-alt me-2"></i>Quantization
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="testing-tab" data-bs-toggle="tab" data-bs-target="#testing" type="button" role="tab">
                    <i class="fas fa-flask me-2"></i>Testing
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="mainTabContent">
            <!-- Training Tab -->
            <div class="tab-pane fade show active" id="training" role="tabpanel">
                <div class="row">
                    <div class="col-lg-8">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-cog me-2"></i>Training Configuration
                            </div>
                            <div class="card-body">
                                <form id="training-form">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="model-select" class="form-label">Model</label>
                                                <select class="form-select" id="model-select" required>
                                                    <option value="">Loading models...</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label for="input-dir" class="form-label">Training Dataset</label>
                                                <div class="input-group">
                                                    <input type="text" class="form-control" id="input-dir" value="dataset" required readonly>
                                                    <button type="button" class="btn btn-outline-primary" id="browse-input-dir">
                                                        <i class="fas fa-folder-open"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label for="output-dir" class="form-label">Output Directory</label>
                                                <div class="input-group">
                                                    <input type="text" class="form-control" id="output-dir" value="models" required readonly>
                                                    <button type="button" class="btn btn-outline-primary" id="browse-output-dir">
                                                        <i class="fas fa-folder-open"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label for="batch-size" class="form-label">Batch Size</label>
                                                <input type="number" class="form-control" id="batch-size" value="5" required min="1">
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label for="learning-rate" class="form-label">Learning Rate</label>
                                                <input type="text" class="form-control" id="learning-rate" value="3e-6" required>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label for="max-iterations" class="form-label">Max Iterations</label>
                                                <input type="number" class="form-control" id="max-iterations" value="300" required min="1">
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label for="warmup-steps" class="form-label">Warmup Steps</label>
                                                <input type="number" class="form-control" id="warmup-steps" value="30" required min="0">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="max-seq-length" class="form-label">Max Sequence Length</label>
                                                <input type="number" class="form-control" id="max-seq-length" value="2048" min="512" max="8192" step="512" required>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="weight-decay" class="form-label">Weight Decay</label>
                                                <input type="number" class="form-control" id="weight-decay" value="0.01" step="0.001" min="0" max="0.1" required>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="lr-decay-factor" class="form-label">LR Decay Factor</label>
                                                <input type="number" class="form-control" id="lr-decay-factor" value="0.1" step="0.01" min="0.01" max="1.0" required>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="fine-tune-type" class="form-label">Fine-tuning Type</label>
                                                <select class="form-select" id="fine-tune-type" required>
                                                    <option value="full" selected>Full (all parameters)</option>
                                                    <option value="lora">LoRA</option>
                                                    <option value="dora">DoRA</option>
                                                </select>
                                                <small class="form-text text-muted">Full trains all parameters, LoRA/DoRA use parameter-efficient methods</small>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="num-layers" class="form-label">Layers to Fine-tune</label>
                                                <input type="number" class="form-control" id="num-layers" value="-1" min="-1" max="100" step="1" required>
                                                <small class="form-text text-muted">Use -1 for all layers or specify number (for LoRA/DoRA)</small>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- LoRA/DoRA Parameters (only shown when LoRA/DoRA is selected) -->
                                    <div class="row" id="lora-params-section" style="display: none;">
                                        <div class="col-12">
                                            <div class="alert alert-info">
                                                <i class="fas fa-info-circle me-2"></i>
                                                <strong>LoRA/DoRA Parameters:</strong> These settings control the adapter training behavior
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label for="lora-rank" class="form-label">LoRA Rank</label>
                                                <input type="number" class="form-control" id="lora-rank" value="32" min="1" max="512" step="1">
                                                <small class="form-text text-muted">Higher rank = more parameters, better quality (8-64 typical)</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label for="lora-scale" class="form-label">LoRA Scale</label>
                                                <input type="number" class="form-control" id="lora-scale" value="16" min="0.1" max="100" step="0.1">
                                                <small class="form-text text-muted">Scaling factor for adapter weights (10-30 typical)</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label for="lora-dropout" class="form-label">LoRA Dropout</label>
                                                <input type="number" class="form-control" id="lora-dropout" value="0.0" min="0.0" max="0.9" step="0.01">
                                                <small class="form-text text-muted">Dropout rate for regularization (0.0-0.1 typical)</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label for="lora-modules" class="form-label">Target Modules</label>
                                                <select class="form-select" id="lora-modules">
                                                    <option value="default" selected>Default (q_proj, v_proj)</option>
                                                    <option value="all_linear">All Linear Layers</option>
                                                    <option value="attention_only">Attention Only</option>
                                                    <option value="custom">Custom</option>
                                                </select>
                                                <small class="form-text text-muted">Which layers to apply LoRA to</small>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="lr-schedule" class="form-label">LR Schedule</label>
                                                <select class="form-select" id="lr-schedule" required>
                                                    <option value="cosine_decay">Cosine Decay</option>
                                                    <option value="linear_decay">Linear Decay</option>
                                                    <option value="constant">Constant</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label for="save-every" class="form-label">Save Every X Steps</label>
                                                <select class="form-select" id="save-every" required>
                                                    <option value="5">5 steps</option>
                                                    <option value="10">10 steps</option>
                                                    <option value="25" selected>25 steps</option>
                                                    <option value="50">50 steps</option>
                                                    <option value="100">100 steps</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label for="eval-every" class="form-label">Eval Every X Steps</label>
                                                <select class="form-select" id="eval-every" required>
                                                    <option value="5">5</option>
                                                    <option value="10">10</option>
                                                    <option value="25" selected>25</option>
                                                    <option value="50">50</option>
                                                    <option value="100">100</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label for="val-fast-pct" class="form-label">Quick Val %</label>
                                                <input type="number" class="form-control" id="val-fast-pct" value="1.0" step="0.01" min="0.05" max="1" required>
                                                <small class="form-text text-muted">Percentage of validation set used for quick checks</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label for="validation-split" class="form-label">Validation Split</label>
                                                <input type="number" class="form-control" id="validation-split" value="0.1" step="0.01" min="0.05" max="0.3" required>
                                                <small class="form-text text-muted">Fraction of data used for validation</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <div class="form-check mt-4">
                                                    <!-- Early stopping is disabled by default. Users can enable it here. -->
                                                    <input class="form-check-input" type="checkbox" id="enable-early-stopping">
                                                    <label class="form-check-label" for="enable-early-stopping">
                                                        Enable Early Stopping
                                                    </label>
                                                    <small class="form-text text-muted">When enabled, training stops if validation loss stops improving (disabled by default)</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Training Estimates -->
                                    <div class="row">
                                        <div class="col-12">
                                            <div class="alert alert-info" id="training-estimates">
                                                <i class="fas fa-calculator me-2"></i>
                                                <strong>Training Estimates:</strong>
                                                <span id="epoch-estimate">Configure parameters to see estimates</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Learning Rate Schedule Preview -->
                                    <div class="row mt-3">
                                        <div class="col-12">
                                            <div class="card mb-4">
                                                <div class="card-header">
                                                    <i class="fas fa-chart-line me-2"></i>Learning Rate Schedule Preview
                                                </div>
                                                <div class="card-body">
                                                    <div id="lr-schedule-chart" style="height: 300px;"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                        <button type="button" class="btn btn-danger me-md-2" id="stop-training-form-btn" disabled>
                                            <i class="fas fa-stop me-2"></i>Stop Training
                                        </button>
                                        <button type="submit" class="btn btn-primary" id="start-training-btn">
                                            <i class="fas fa-play me-2"></i>Start Training
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-4">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-info-circle me-2"></i>Training Status
                            </div>
                            <div class="card-body">
                                <div id="training-status">
                                    <div class="text-center text-muted">
                                        <i class="fas fa-clock fa-2x mb-3"></i>
                                        <p>No training in progress</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card mt-3">
                            <div class="card-header">
                                <i class="fas fa-graduation-cap me-2"></i>Training Sessions
                            </div>
                            <div class="card-body">
                                <!-- Search Bar -->
                                <div class="mb-3">
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text">
                                            <i class="fas fa-search"></i>
                                        </span>
                                        <input type="text" class="form-control" id="training-session-search-input" placeholder="Search sessions by model, type, or parameters...">
                                        <button class="btn btn-outline-secondary" type="button" id="training-clear-search-btn" title="Clear search">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div id="checkpoints-list">
                                    <div class="text-center text-muted">
                                        <i class="fas fa-folder-open fa-2x mb-3"></i>
                                        <p>Loading checkpoints...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Monitoring Tab -->
            <div class="tab-pane fade" id="monitoring" role="tabpanel">
                <div class="row">
                    <!-- Training Session Selection -->
                    <div class="col-12 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-history me-2"></i>Training Session
                            </div>
                            <div class="card-body">
                                <div class="row align-items-end">
                                    <div class="col-md-8">
                                        <label for="training-session-select" class="form-label">Select Training Session</label>
                                        <select class="form-select" id="training-session-select">
                                            <option value="">Current training session</option>
                                        </select>
                                    </div>
                                                        <div class="col-md-4 d-flex gap-2">
                        <button type="button" class="btn btn-danger" id="stop-training-monitor-btn" style="display: none;" title="Stop active training">
                            <i class="fas fa-stop me-2"></i>Stop Training
                        </button>
                        <button type="button" class="btn btn-primary flex-grow-1" id="load-session-btn">
                            <i class="fas fa-eye me-2"></i>View Session
                        </button>
                        <button type="button" class="btn btn-outline-info" id="view-logs-btn" title="View session logs">
                            <i class="fas fa-file-code"></i>
                        </button>
                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Key Metrics -->
                    <div class="col-12">
                        <div class="row" id="metrics-row">
                            <div class="col-md-2">
                                <div class="metric-card">
                                    <div class="metric-value" id="current-iteration">-</div>
                                    <div class="metric-label">Iteration</div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="metric-card">
                                    <div class="metric-value" id="train-loss">-</div>
                                    <div class="metric-label">Train Loss</div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="metric-card">
                                    <div class="metric-value" id="val-loss">-</div>
                                    <div class="metric-label">Val Loss</div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="metric-card">
                                    <div class="metric-value" id="perplexity">-</div>
                                    <div class="metric-label">Perplexity</div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="metric-card">
                                    <div class="metric-value" id="tokens-per-sec">-</div>
                                    <div class="metric-label">Tokens/sec</div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="metric-card">
                                    <div class="metric-value" id="trained-tokens">-</div>
                                    <div class="metric-label">Trained Tokens</div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="metric-card">
                                    <div class="metric-value" id="epoch-done">-</div>
                                    <div class="metric-label">Epoch</div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="metric-card">
                                    <div class="metric-value" id="memory-usage">-</div>
                                    <div class="metric-label">Memory (GB)</div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="metric-card">
                                                                    <div class="metric-value" id="display-learning-rate">-</div>
                                <div class="metric-label">Learning Rate</div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="metric-card">
                                <div class="metric-value" id="display-warmup-steps">-</div>
                                <div class="metric-label">Warmup Steps</div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="metric-card">
                                <div class="metric-value" id="display-lr-decay-factor">-</div>
                                <div class="metric-label">LR Decay</div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="metric-card">
                                <div class="metric-value" id="display-weight-decay">-</div>
                                <div class="metric-label">Weight Decay</div>
                            </div>
                        </div>
                        </div>
                    </div>
                    
                    <!-- Progress Bar -->
                    <div class="col-12 mb-4">
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span>Training Progress</span>
                                    <div class="d-flex align-items-center gap-3">
                                        <span id="elapsed-time" class="text-muted small">E.Time: --</span>
                                        <span id="eta-time" class="text-muted small">R.Time: --</span>
                                        <span id="progress-text">0%</span>
                                    </div>
                                </div>
                                <div class="progress">
                                    <div class="progress-bar" id="progress-bar" role="progressbar" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Charts -->
                    <div class="col-lg-6">
                        <div class="chart-container">
                            <div id="loss-chart"></div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="chart-container">
                            <div id="perplexity-chart"></div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="chart-container">
                            <div id="lr-chart"></div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="chart-container">
                            <div id="speed-chart"></div>
                        </div>
                    </div>
                    
                    <!-- Best Checkpoints -->
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-trophy me-2"></i>Top 3 Best Checkpoints
                            </div>
                            <div class="card-body">
                                <div id="best-checkpoints">
                                    <div class="text-center text-muted">
                                        <i class="fas fa-chart-line fa-2x mb-3"></i>
                                        <p>No training data available</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- All Checkpoints Selection -->
                    <div class="col-12 mt-3">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-list-alt me-2"></i>All Available Checkpoints
                            </div>
                            <div class="card-body">
                                <div class="row align-items-end">
                                    <div class="col-md-8">
                                        <label for="checkpoint-select" class="form-label">Select Checkpoint to Publish</label>
                                        <select class="form-select" id="checkpoint-select">
                                            <option value="">Select a checkpoint...</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <button type="button" class="btn btn-primary w-100" id="publish-selected-checkpoint-btn">
                                            <i class="fas fa-cloud-upload-alt me-2"></i>Publish Selected Checkpoint
                                        </button>
                                    </div>
                                </div>
                                <div class="mt-3 small text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    This list shows all available checkpoints for the selected training session.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Compare Tab -->
            <div class="tab-pane fade" id="compare" role="tabpanel">
                <div class="row">
                    <!-- Left panel: Session Selection -->
                    <div class="col-lg-3">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-list me-2"></i>Training Sessions
                                <button class="btn btn-sm btn-outline-primary float-end" id="refresh-sessions-btn" title="Refresh sessions list">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                            <div class="card-body">
                                <!-- Dataset Warning -->
                                <div class="alert alert-warning" role="alert">
                                    <small><i class="fas fa-exclamation-triangle me-2"></i>
                                    <strong>Important:</strong> <i>only compare sessions trained on the same dataset</i></small>.
                                </div>
                                
                                <!-- Search Bar -->
                                <div class="mb-3">
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text">
                                            <i class="fas fa-search"></i>
                                        </span>
                                        <input type="text" class="form-control" id="session-search-input" placeholder="Search sessions by model, type, or parameters...">
                                        <button class="btn btn-outline-secondary" type="button" id="clear-search-btn" title="Clear search">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Clear All Button (always visible at top) -->
                                <div class="mb-3">
                                    <button class="btn btn-sm btn-secondary w-100" id="clear-selection-btn">
                                        <i class="fas fa-times me-2"></i>Clear All
                                    </button>
                                </div>
                                
                                <!-- Session List -->
                                <div id="compare-sessions-list">
                                    <div class="text-center text-muted">
                                        <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                                        <p>Loading training sessions...</p>
                                    </div>
                                </div>

                            </div>
                        </div>
                        
                        <!-- Comparison Statistics -->
                        <div class="card mt-3" id="comparison-stats-card" style="display: none;">
                            <div class="card-header">
                                <i class="fas fa-calculator me-2"></i>Comparison Statistics
                            </div>
                            <div class="card-body">
                                <div id="comparison-stats-content">
                                    <!-- Statistics will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Center panel: Comparison Charts -->
                    <div class="col-lg-9">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="fas fa-chart-area me-2"></i>Training Analysis Dashboard
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="comparison-charts-container">
                                    <!-- Default state -->
                                    <div class="text-center text-muted py-5" id="comparison-placeholder">
                                        <i class="fas fa-chart-line fa-4x mb-4" style="opacity: 0.3;"></i>
                                        <h4>Training Session Analysis</h4>
                                        <p class="lead">Select one or more training sessions from the left panel to view their performance metrics and compare results.</p>
                                        <div class="row text-start mt-4">
                                            <div class="col-md-6">
                                                <h6><i class="fas fa-chart-line me-2"></i>Available Analysis:</h6>
                                                <ul class="list-unstyled">
                                                    <li><i class="fas fa-arrow-trend-down me-2 text-primary"></i>Loss Curves</li>
                                                    <li><i class="fas fa-brain me-2 text-success"></i>Perplexity Evolution</li>
                                                    <li><i class="fas fa-wave-square me-2 text-warning"></i>Loss Stability</li>
                                                    <li><i class="fas fa-balance-scale me-2 text-info"></i>Generalization Gap</li>
                                                </ul>
                                            </div>
                                            <div class="col-md-6">
                                                <h6><i class="fas fa-lightbulb me-2"></i>Tips:</h6>
                                                <ul class="list-unstyled">
                                                    <li><i class="fas fa-eye me-2 text-success"></i>View single session metrics</li>
                                                    <li><i class="fas fa-balance-scale me-2 text-primary"></i>Compare multiple sessions</li>
                                                    <li><i class="fas fa-check me-2 text-warning"></i>Use same training dataset</li>
                                                    <li><i class="fas fa-cogs me-2 text-info"></i>Review hyperparameters</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Charts Grid (2x2) -->
                                    <div id="comparison-charts-grid" style="display: none;">
                                        <div class="row">
                                            <!-- Loss Comparison -->
                                            <div class="col-lg-6 mb-4">
                                                <div class="card h-100">
                                                    <div class="card-header">
                                                        <i class="fas fa-chart-line me-2"></i>Loss Analysis
                                                        <small class="text-muted float-end">Training vs Validation</small>
                                                    </div>
                                                    <div class="card-body p-2">
                                                        <div id="loss-comparison-chart" style="height: 300px;"></div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Perplexity Comparison -->
                                            <div class="col-lg-6 mb-4">
                                                <div class="card h-100">
                                                    <div class="card-header">
                                                        <i class="fas fa-brain me-2"></i>Perplexity Analysis
                                                        <small class="text-muted float-end">Lower is better</small>
                                                    </div>
                                                    <div class="card-body p-2">
                                                        <div id="perplexity-comparison-chart" style="height: 300px;"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <!-- Loss Stability Comparison -->
                                            <div class="col-lg-6 mb-4">
                                                <div class="card h-100">
                                                    <div class="card-header">
                                                        <i class="fas fa-wave-square me-2"></i>Loss Stability
                                                        <small class="text-muted float-end">Variance analysis</small>
                                                    </div>
                                                    <div class="card-body p-2">
                                                        <div id="stability-comparison-chart" style="height: 300px;"></div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Generalization Gap Comparison -->
                                            <div class="col-lg-6 mb-4">
                                                <div class="card h-100">
                                                    <div class="card-header">
                                                        <i class="fas fa-balance-scale me-2"></i>Generalization Gap
                                                        <small class="text-muted float-end">Val Loss - Train Loss</small>
                                                    </div>
                                                    <div class="card-body p-2">
                                                        <div id="generalization-comparison-chart" style="height: 300px;"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                </div>
                
                <!-- Summary Table (shown when sessions are selected, full width) -->
                <div class="card mt-4" id="summary-table-card" style="display: none;">
                    <div class="card-header">
                        <i class="fas fa-table me-2"></i>Training Sessions Summary
                        <small class="text-muted float-end">Sorted by validation loss (best first)</small>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="sessions-summary-table">
                                                                        <thead class="table-light">
                                            <tr>
                                                <th>Training Session</th>
                                                <th>Type</th>
                                                <th>Method</th>
                                                <th>Seq Len</th>
                                                <th>Best Checkpoint</th>
                                                <th>Best Loss</th>
                                                <th>Learning Rate</th>
                                                <th>LR Decay</th>
                                                <th>Weight Decay</th>
                                                <th>Batch Size</th>
                                                <th>Warmup Steps</th>
                                                <th>LoRA Rank</th>
                                                <th>LoRA Scale</th>
                                                <th>LoRA Dropout</th>
                                                <th>Layers</th>
                                                <th>Target Modules</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                <tbody id="sessions-summary-tbody">
                                    <!-- Table rows will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Fuse Tab -->
            <div class="tab-pane fade" id="fuse" role="tabpanel">
                <div class="row">
                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-layer-group me-2"></i>Model Fusion
                            </div>
                            <div class="card-body">
                                <form id="fuse-form">
                                    <div class="mb-3">
                                        <label for="fuse-adapter-select" class="form-label">LoRA/DoRA Adapter</label>
                                        <select class="form-select" id="fuse-adapter-select" required>
                                            <option value="">Select adapter...</option>
                                        </select>
                                        <div class="form-text">Choose the trained adapter to fuse. The base model will be automatically detected from the adapter's configuration.</div>
                                    </div>
                                    
                                    <div class="mb-3" id="fuse-base-model-info" style="display: none;">
                                        <label class="form-label">Detected Base Model</label>
                                        <div class="alert alert-info">
                                            <i class="fas fa-robot me-2"></i>
                                            <span id="fuse-detected-base-model">None detected</span>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3" id="fuse-output-info" style="display: none;">
                                        <label class="form-label">Output Model Name</label>
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle me-2"></i>
                                            <span id="fuse-output-model-name">model_name_fused</span>
                                        </div>
                                    </div>
                                    
                                    <div class="d-grid">
                                        <button type="button" class="btn btn-primary" id="start-fuse-btn">
                                            <i class="fas fa-layer-group me-2"></i>Start Fusion
                                        </button>
                                        <button type="button" class="btn btn-danger mt-2" id="stop-fuse-btn" style="display: none;">
                                            <i class="fas fa-stop me-2"></i>Stop Fusion
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-6">
                        <!-- Progress Card -->
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-tasks me-2"></i>Fusion Progress
                            </div>
                            <div class="card-body">
                                <div id="fuse-progress-container">
                                    <div class="text-center text-muted py-4" id="fuse-idle">
                                        <i class="fas fa-layer-group fa-3x mb-3" style="color: var(--text-muted);"></i>
                                        <h5>Ready for Fusion</h5>
                                        <p>Select a trained adapter, then click "Start Fusion" to begin. The base model will be automatically detected.</p>
                                    </div>
                                    
                                    <div id="fuse-active" style="display: none;">
                                        <!-- Progress Bar -->
                                        <div class="mb-3">
                                            <div class="d-flex justify-content-between mb-1">
                                                <span class="text-muted">Progress</span>
                                                <span class="text-muted"><span id="fuse-progress-percentage">0</span>%</span>
                                            </div>
                                            <div class="progress" style="height: 20px;">
                                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                                     id="fuse-progress-bar" 
                                                     role="progressbar" 
                                                     style="width: 0%">
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Status Message -->
                                        <div class="mb-3">
                                            <label class="form-label">Status</label>
                                            <div class="alert alert-info mb-0">
                                                <i class="fas fa-info-circle me-2"></i>
                                                <span id="fuse-status-message">Initializing...</span>
                                            </div>
                                        </div>
                                        
                                        <!-- Time Information -->
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="metric-card">
                                                    <div class="metric-value" id="fuse-elapsed-time">00:00</div>
                                                    <div class="metric-label">Elapsed Time</div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="metric-card">
                                                    <div class="metric-value" id="fuse-estimated-remaining">--:--</div>
                                                    <div class="metric-label">Est. Remaining</div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Job Information -->
                                        <div class="mt-3">
                                            <h6>Current Job</h6>
                                            <div class="small text-muted">
                                                <div><strong>Base Model:</strong> <span id="fuse-current-base-model">-</span></div>
                                                <div><strong>Adapter:</strong> <span id="fuse-current-adapter">-</span></div>
                                                <div><strong>Output:</strong> <span id="fuse-current-output-model">-</span></div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Error Display -->
                                    <div id="fuse-error" class="alert alert-danger" style="display: none;">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        <span id="fuse-error-message">An error occurred</span>
                                    </div>
                                    
                                    <!-- Success Display -->
                                    <div id="fuse-success" class="alert alert-success" style="display: none;">
                                        <div class="d-flex align-items-start">
                                            <div class="flex-grow-1 me-3">
                                                <div class="d-flex align-items-center mb-2">
                                                    <i class="fas fa-check-circle me-2"></i>
                                                    <span id="fuse-success-message">Fusion completed successfully!</span>
                                                </div>
                                            </div>
                                            <button type="button" class="btn btn-outline-success btn-sm flex-shrink-0" id="open-fusion-folder-btn" 
                                                    data-bs-toggle="tooltip" data-bs-placement="top" 
                                                    title="Open the folder containing the fused model (only works for locally trained models)">
                                                <i class="fas fa-folder-open me-1"></i>Open Folder
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quantization Tab -->
            <div class="tab-pane fade" id="quantization" role="tabpanel">
                <div class="row">
                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-compress-alt me-2"></i>Model Quantization
                            </div>
                            <div class="card-body">
                                <form id="quantization-form">
                                    <div class="mb-3">
                                        <label for="quantization-model-select" class="form-label">Select Model to Quantize</label>
                                        <select class="form-select" id="quantization-model-select" required>
                                            <option value="">Loading models...</option>
                                        </select>
                                        <div class="form-text">Choose from local models or HuggingFace cache</div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="quantization-bits" class="form-label">Quantization Bits</label>
                                                <select class="form-select" id="quantization-bits" required>
                                                    <option value="4" selected>4-bit (High compression)</option>
                                                    <option value="8">8-bit (Balanced)</option>
                                                </select>
                                                <div class="form-text">Lower bits = smaller model, slightly lower quality</div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="quantization-group-size" class="form-label">Group Size</label>
                                                <select class="form-select" id="quantization-group-size" required>
                                                    <option value="32">32 (Higher quality)</option>
                                                    <option value="64" selected>64 (Recommended)</option>
                                                    <option value="128">128 (Faster)</option>
                                                </select>
                                                <div class="form-text">Smaller groups = better quality, larger file</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3" id="quantization-output-info" style="display: none;">
                                        <label class="form-label">Output Model Name</label>
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle me-2"></i>
                                            <span id="output-model-name">model_name_Q4</span>
                                        </div>
                                    </div>
                                    
                                    <div class="d-grid">
                                        <button type="button" class="btn btn-primary" id="start-quantization-btn">
                                            <i class="fas fa-compress-alt me-2"></i>Start Quantization
                                        </button>
                                        <button type="button" class="btn btn-danger mt-2" id="stop-quantization-btn" style="display: none;">
                                            <i class="fas fa-stop me-2"></i>Stop Quantization
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        
                        <!-- Quantized Models List -->
                        <div class="card mt-4">
                            <div class="card-header">
                                <i class="fas fa-archive me-2"></i>Quantized Models
                            </div>
                            <div class="card-body">
                                <div id="quantized-models-list">
                                    <div class="text-center text-muted py-3">
                                        <i class="fas fa-box-open fa-2x mb-2"></i>
                                        <p>No quantized models yet</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-6">
                        <!-- Progress Card -->
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-tasks me-2"></i>Quantization Progress
                            </div>
                            <div class="card-body">
                                <div id="quantization-progress-container">
                                    <div class="text-center text-muted py-4" id="quantization-idle">
                                        <i class="fas fa-compress-alt fa-3x mb-3" style="color: var(--text-muted);"></i>
                                        <h5>Ready for Quantization</h5>
                                        <p>Select a model and click "Start Quantization" to begin</p>
                                    </div>
                                    
                                    <div id="quantization-active" style="display: none;">
                                        <!-- Progress Bar -->
                                        <div class="mb-3">
                                            <div class="d-flex justify-content-between mb-1">
                                                <span class="text-muted">Progress</span>
                                                <span class="text-muted"><span id="progress-percentage">0</span>%</span>
                                            </div>
                                            <div class="progress" style="height: 20px;">
                                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                                     id="quantization-progress-bar" 
                                                     role="progressbar" 
                                                     style="width: 0%">
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Status Message -->
                                        <div class="mb-3">
                                            <label class="form-label">Status</label>
                                            <div class="alert alert-info mb-0">
                                                <i class="fas fa-info-circle me-2"></i>
                                                <span id="quantization-status-message">Initializing...</span>
                                            </div>
                                        </div>
                                        
                                        <!-- Time Information -->
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="metric-card">
                                                    <div class="metric-value" id="elapsed-time">00:00</div>
                                                    <div class="metric-label">Elapsed Time</div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="metric-card">
                                                    <div class="metric-value" id="estimated-remaining">--:--</div>
                                                    <div class="metric-label">Est. Remaining</div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Job Information -->
                                        <div class="mt-3">
                                            <h6>Current Job</h6>
                                            <div class="small text-muted">
                                                <div><strong>Input:</strong> <span id="current-input-model">-</span></div>
                                                <div><strong>Output:</strong> <span id="current-output-model">-</span></div>
                                                <div><strong>Settings:</strong> <span id="current-settings">-</span></div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Error Display -->
                                    <div id="quantization-error" class="alert alert-danger" style="display: none;">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        <span id="quantization-error-message">An error occurred</span>
                                    </div>
                                    
                                    <!-- Success Display -->
                                    <div id="quantization-success" class="alert alert-success" style="display: none;">
                                        <i class="fas fa-check-circle me-2"></i>
                                        <span id="quantization-success-message">Quantization completed successfully!</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tips Card -->
                        <div class="card mt-4">
                            <div class="card-header">
                                <i class="fas fa-lightbulb me-2"></i>Quantization Tips
                            </div>
                            <div class="card-body">
                                <div class="small">
                                    <div class="mb-2">
                                        <strong>4-bit vs 8-bit:</strong> 4-bit provides better compression (~75% size reduction) 
                                        but slightly lower quality. 8-bit offers better quality with ~50% compression.
                                    </div>
                                    <div class="mb-2">
                                        <strong>Group Size:</strong> Smaller groups (32) provide better quality but larger files. 
                                        64 is the recommended balance.
                                    </div>
                                    <div class="mb-2">
                                        <strong>Performance:</strong> Quantized models are faster to load and use less memory, 
                                        making them ideal for deployment.
                                    </div>
                                    <div>
                                        <strong>Compatibility:</strong> Quantized models work with the same inference code 
                                        as the original models.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Testing Tab -->
            <div class="tab-pane fade" id="testing" role="tabpanel">
                <div class="row">
                    <div class="col-lg-4">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-cogs me-2"></i>Model Configuration
                            </div>
                            <div class="card-body">
                                <form id="model-load-form" onsubmit="return false;">
                                    <div class="mb-3">
                                        <label for="test-model-select" class="form-label">Base Model</label>
                                        <div class="input-group">
                                            <select class="form-select" id="test-model-select">
                                                <option value="">Select model...</option>
                                            </select>
                                            <button class="btn btn-outline-secondary" type="button" id="copy-model-path-btn" title="Copy full model path">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                            <button class="btn btn-outline-primary" type="button" id="open-model-folder-btn" title="Open model folder (only works when server and client are on the same machine)">
                                                <i class="fas fa-folder-open"></i>
                                            </button>
                                            <button class="btn btn-outline-info" type="button" id="view-dashboard-btn" title="View training dashboard" disabled>
                                                <i class="fas fa-chart-line"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="adapter-path" class="form-label">Adapter Path (Optional)</label>
                                        <div class="input-group">
                                            <select class="form-select" id="adapter-path">
                                                <option value="">No adapter (base model only)</option>
                                            </select>
                                            <button class="btn btn-outline-secondary" type="button" id="copy-adapter-path-btn" title="Copy full adapter path">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                        </div>
                                        <small class="form-text text-muted">
                                            <i class="fas fa-lightbulb"></i> 
                                            <strong>Tip:</strong> You can select just an adapter to automatically load it with its base model!
                                        </small>
                                    </div>
                                    <div class="mb-3">
                                        <label for="system-prompt" class="form-label">System Prompt</label>
                                        <textarea class="form-control" id="system-prompt" rows="2" placeholder="Optional system prompt to guide model behavior..."
                                                  title="Instructions that define the AI's behavior, capabilities, and limitations. This sets the overall tone and context for the conversation."></textarea>
                                    </div>
                                    
                                    <!-- Generation Parameters Section -->
                                    <div class="mb-3">
                                        <label class="form-label">Generation Parameters</label>
                                        <div class="row g-2 mb-2">
                                            <div class="col-md-6">
                                                <label for="max-tokens" class="form-label small">Max Tokens</label>
                                                <input type="number" class="form-control" id="max-tokens" value="2000" min="1" required
                                                       title="Maximum number of tokens to generate. Higher values allow for longer responses but may take more time.">
                                            </div>
                                            <div class="col-md-6">
                                                <label for="max-kv-size" class="form-label small">Context Window</label>
                                                <select class="form-select" id="max-kv-size" 
                                                        title="Maximum context size in tokens. Larger values allow the model to reference more of the conversation history, but use more memory.">
                                                    <option value="512">512</option>
                                                    <option value="1024">1K (1,024)</option>
                                                    <option value="2048">2K (2,048)</option>
                                                    <option value="4096">4K (4,096)</option>
                                                    <option value="8192">8K (8,192)</option>
                                                    <option value="16384" selected>16K (16,384)</option>
                                                    <option value="32768">32K (32,768)</option>
                                                    <option value="65536">64K (65,536)</option>
                                                    <option value="131072">128K (131,072)</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="row g-2 mb-2">
                                            <div class="col-md-4">
                                                <div class="input-group input-group-sm">
                                                    <span class="input-group-text">Temp</span>
                                                    <input type="number" class="form-control" id="temperature" value="0.7" min="0.0" max="2.0" step="0.1"
                                                           title="Controls randomness: 0 = deterministic, 0.7 = balanced, 2.0 = very random. Lower values are more focused and coherent, higher values are more creative.">
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="input-group input-group-sm">
                                                    <span class="input-group-text">Top P</span>
                                                    <input type="number" class="form-control" id="top-p" value="0.9" min="0.0" max="1.0" step="0.05"
                                                           title="Nucleus sampling: Only consider tokens with cumulative probability < top_p. Lower values (0.5) focus on likely tokens, higher values (0.9-1.0) allow more variety.">
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="input-group input-group-sm">
                                                    <span class="input-group-text">Rep. Pen</span>
                                                    <input type="number" class="form-control" id="repetition-penalty" value="1.1" min="1.0" max="2.0" step="0.05"
                                                           title="Penalizes repetition: 1.0 = no penalty, 1.1-1.2 = balanced, 1.5+ = strongly avoid repetition. Higher values reduce repeated phrases but may affect fluency.">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row g-2 mb-2">
                                            <div class="col-md-4">
                                                <div class="input-group input-group-sm">
                                                    <span class="input-group-text">Seed</span>
                                                    <input type="number" class="form-control" id="seed" value="42" min="1" max="2147483647" step="1" title="Random seed for deterministic generation">
                                                </div>
                                            </div>
                                            <div class="col-md-8">
                                                <small class="text-muted">
                                                    <i class="fas fa-dice me-1"></i>Set seed for reproducible generation (same seed = same output)
                                                </small>
                                            </div>
                                        </div>
                                        <div class="row g-2">
                                            <div class="col-md-6">
                                                <div class="form-check form-switch">
                                                                                    <input class="form-check-input" type="checkbox" id="streaming-toggle" checked
                                                           title="When enabled, text appears gradually as it's generated. Provides a more interactive experience but may slightly increase latency.">
                                <label class="form-check-label" for="streaming-toggle">
                                                        <i class="fas fa-stream me-1"></i>Real-time Streaming
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <small class="text-muted">
                                                    <i class="fas fa-info-circle me-1"></i>Shows text as it's generated
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="d-flex flex-wrap justify-content-between align-items-center">
                                        <button type="button" class="btn btn-warning mb-2 mb-md-0" id="reset-config-btn" title="Reset all parameters to defaults and unload current model">
                                            <i class="fas fa-undo me-2"></i>Reset
                                        </button>
                                        <div class="d-flex flex-nowrap gap-2">
                                            <button type="button" class="btn btn-danger" id="unload-model-btn" disabled>
                                                <i class="fas fa-times me-2"></i>Unload Model
                                            </button>
                                            <button type="button" class="btn btn-primary" id="load-model-btn">
                                                <i class="fas fa-download me-2"></i>Load Model
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-8">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="fas fa-terminal me-2"></i>Generation Output
                                </div>
                                <button id="fullscreen-btn" class="btn btn-sm btn-primary" data-bs-toggle="tooltip" title="Toggle fullscreen view">
                                    <i class="fas fa-expand"></i> Fullscreen
                                </button>
                            </div>
                            <div class="card-body p-0">
                                <!-- Toolbar -->
                                <div class="d-flex justify-content-between align-items-center px-3 py-2 border-bottom">
                                    <div class="btn-group" role="group" aria-label="Chat toolbar">
                                        <button id="clear-chat-btn" class="btn btn-sm btn-outline-secondary" disabled>
                                            <i class="fas fa-trash"></i> Clear
                                        </button>
                                        <button id="toggle-chat-btn" class="btn btn-sm btn-outline-secondary" data-bs-toggle="tooltip" title="Toggle chat history for context (on by default)">
                                            <i class="fas fa-book-open"></i> History: On
                                        </button>
                                        <button id="toggle-markdown-btn" class="btn btn-sm btn-outline-primary d-none" data-bs-toggle="tooltip" title="Toggle markdown rendering (on by default)">
                                            <i class="fab fa-markdown"></i> Markdown: On
                                        </button>
                                        <button id="save-chat-btn" class="btn btn-sm btn-outline-primary" disabled data-bs-toggle="tooltip" title="Saves conversation with model metadata">
                                            <i class="fas fa-save"></i> Save History <i class="fas fa-tag small"></i>
                                        </button>
                                        <button id="load-chat-btn" class="btn btn-sm btn-outline-success" data-bs-toggle="tooltip" title="Load previously saved conversation">
                                            <i class="fas fa-upload"></i> Load History
                                        </button>
                                    </div>
                                    <small id="chat-stats" class="text-muted text-end" style="text-align: right; line-height: 1.2;"></small>
                                </div>

                                <!-- Chat history -->
                                <div id="chat-history" class="list-group overflow-auto" style="height:60vh;">
                                    <!-- Welcome message when no chat history -->
                                    <div class="d-flex flex-column align-items-center justify-content-center h-100 text-muted" id="chat-welcome">
                                        <i class="fas fa-robot fa-3x mb-3" style="color: var(--text-muted);"></i>
                                        <p class="text-center">Model ready! Type a message below to start the conversation.</p>
                                    </div>
                                </div>
                                
                                <!-- Chat input (appears when model is loaded) -->
                                <div id="chat-input-container" class="px-3 py-2 border-top d-none">
                                    <div class="input-group">
                                        <textarea id="chat-input" class="form-control" placeholder="Type your message here... (Press Enter to send, Shift+Enter for new line)" rows="1" style="resize: none; overflow-y: hidden;"></textarea>
                                        <button class="btn btn-primary" type="button" id="send-message-btn" disabled>
                                            <i class="fas fa-paper-plane"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        

                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p id="modal-loading-message">Processing...</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Logs Modal -->
    <div class="modal fade" id="logsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Training Logs</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="logs-content" class="bg-light p-3" style="max-height: 70vh; overflow-y: auto;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="copy-logs-btn">
                        <i class="fas fa-copy me-2"></i>Copy to Clipboard
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Dashboard Modal -->
    <div class="modal fade" id="dashboardModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-xl" style="max-width: 90%;">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Training Dashboard</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="dashboard-image" src="" class="img-fluid" alt="Training Dashboard" style="max-width: 100%;">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden file input for loading chat history -->
    <input type="file" id="load-history-file-input" accept=".json" style="display: none;">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="position-fixed top-0 start-0 w-100 h-100 bg-dark bg-opacity-50 d-flex justify-content-center align-items-center d-none" style="z-index: 1050;">
        <div class="card p-4">
            <div class="d-flex align-items-center">
                <div class="spinner-border text-primary me-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <div id="loading-message">Loading...</div>
            </div>
        </div>
    </div>
    
    <!-- Confirm Modal -->
    <div class="modal fade" id="confirm-modal" tabindex="-1" aria-labelledby="confirm-modal-title" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirm-modal-title">Confirm</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="confirm-modal-body">
                    Are you sure you want to proceed?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirm-modal-confirm">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <!-- File Browser Modal -->
    <div class="modal fade" id="file-browser-modal" tabindex="-1" aria-labelledby="file-browser-title" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="file-browser-title">Select Directory</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex align-items-center mb-3">
                        <button type="button" class="btn btn-outline-secondary me-2" id="browser-up-btn" disabled>
                            <i class="fas fa-arrow-up"></i> Up
                        </button>
                        <div class="flex-grow-1">
                            <input type="text" class="form-control" id="browser-current-path" readonly>
                        </div>
                    </div>
                    <div id="browser-loading" class="text-center d-none">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading directory contents...</p>
                    </div>
                    <div id="browser-content" class="border rounded" style="height: 400px; overflow-y: auto;">
                        <!-- Directory contents will be loaded here -->
                    </div>
                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="fas fa-info-circle"></i>
                            Select a directory by clicking on it, then click "Select Directory" to choose it.
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="browser-select-btn" disabled>
                        <i class="fas fa-check"></i> Select Directory
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Fusion Configuration Modal -->
    <div class="modal fade" id="fusion-config-modal" tabindex="-1" aria-labelledby="fusion-config-title" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="fusion-config-title">
                        <i class="fas fa-layer-group me-2"></i>Configure Fusion
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="fusion-config-form">
                        <div class="mb-3">
                            <label for="fusion-suffix" class="form-label">Model Suffix</label>
                            <input type="text" class="form-control" id="fusion-suffix" placeholder="e.g., _math, _it, _reasoning">
                            <div class="form-text">Optional suffix to add to the fused model name (e.g., _math, _it, _reasoning)</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="fusion-description" class="form-label">Description</label>
                            <textarea class="form-control" id="fusion-description" rows="4" placeholder="Describe what this fused model is for..."></textarea>
                            <div class="form-text">Optional description that will be added to the model's README.md</div>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Preview:</strong>
                            <div class="mt-2 p-2 bg-light rounded">
                                <code id="fusion-preview-name" class="text-break" style="word-break: break-all; white-space: pre-wrap; font-size: 0.9em;">model_name_fused_adapter_name</code>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="fusion-config-confirm">
                        <i class="fas fa-layer-group me-2"></i>Start Fusion
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add the parameters modal for viewing session parameters -->
    <div class="modal fade" id="parameters-modal" tabindex="-1" aria-labelledby="parameters-modal-title" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="parameters-modal-title">Session Parameters</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="parameters-modal-body">
                    <!-- Parameters will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="copy-parameters-btn">
                        <i class="fas fa-copy me-2"></i>Copy to Clipboard
                    </button>
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Fullscreen Overlay -->
    <div id="fullscreen-overlay" class="fullscreen-overlay" style="display: none;">
        <!-- Chat panel will be moved here in fullscreen mode -->
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Marked.js for Markdown rendering -->
    <script src="{{ url_for('static', filename='js/utils/marked.min.js') }}"></script>
    
    <!-- Component Scripts (load before app.js to ensure functions are available) -->
    <script src="{{ url_for('static', filename='js/services/api.js') }}?v={{ cache_buster }}"></script>
    <script src="{{ url_for('static', filename='js/components/quantization.js') }}?v={{ cache_buster }}"></script>
    <script src="{{ url_for('static', filename='js/components/compare.js') }}?v={{ cache_buster }}"></script>
    
    <!-- Custom JavaScript (loads after components) -->
    <script src="{{ url_for('static', filename='app.js') }}?v={{ cache_buster }}"></script>
    
    <!-- Theme Toggle Script -->
    <script>
        // Theme management
        const themeToggle = document.getElementById('theme-toggle');
        const themeIcon = document.getElementById('theme-icon');
        const body = document.body;
        
        // Check for saved theme preference or default to light mode
        const currentTheme = localStorage.getItem('theme') || 'light';
        
        // Apply the current theme
        function applyTheme(theme) {
            if (theme === 'dark') {
                body.setAttribute('data-theme', 'dark');
                themeIcon.className = 'fas fa-sun';
                themeToggle.title = 'Switch to light mode';
            } else {
                body.removeAttribute('data-theme');
                themeIcon.className = 'fas fa-moon';
                themeToggle.title = 'Switch to dark mode';
            }
        }
        
        // Initialize theme
        applyTheme(currentTheme);
        
        // Theme toggle event listener
        themeToggle.addEventListener('click', () => {
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            applyTheme(newTheme);
            localStorage.setItem('theme', newTheme);
        });
    </script>
    
    <!-- Fullscreen Test Script -->
    <script>
        // Wait for DOM to be fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log(' DOM fully loaded - setting up fullscreen test');
            
            // Direct access to fullscreen button
            const fullscreenBtn = document.getElementById('fullscreen-btn');
            const fullscreenOverlay = document.getElementById('fullscreen-overlay');
            
            if (fullscreenBtn) {
                console.log(' Fullscreen button found');
                console.log(' Button properties:', {
                    id: fullscreenBtn.id,
                    classList: fullscreenBtn.className,
                    style: fullscreenBtn.getAttribute('style'),
                    'data-bs-toggle': fullscreenBtn.getAttribute('data-bs-toggle'),
                    title: fullscreenBtn.getAttribute('title')
                });
                
                // Remove the direct onclick handler and use the proper method
                // This ensures we use the same code path for all fullscreen toggles
                fullscreenBtn.onclick = function(e) {
                    console.log(' Direct onclick handler triggered - delegating to trainingInterface.toggleFullscreen()');
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Use the proper method from the training interface
                    if (window.trainingInterface && typeof window.trainingInterface.toggleFullscreen === 'function') {
                        window.trainingInterface.toggleFullscreen();
                    } else {
                        console.error(' trainingInterface.toggleFullscreen not found, using fallback');
                        
                        if (!fullscreenOverlay) {
                            console.error(' Fullscreen overlay not found');
                            return;
                        }
                        
                        const isCurrentlyFullscreen = fullscreenOverlay.style.display === 'flex' || 
                                                    window.getComputedStyle(fullscreenOverlay).display === 'flex';
                        
                        console.log(' Current fullscreen state:', isCurrentlyFullscreen);
                        
                        if (isCurrentlyFullscreen) {
                            console.log(' Exiting fullscreen mode directly');
                            
                            // Return the chat panel to its original location
                            const chatPanel = fullscreenOverlay.querySelector('.card');
                            const originalContainer = document.querySelector('#testing .col-lg-8');
                            
                            if (chatPanel && originalContainer) {
                                originalContainer.appendChild(chatPanel);
                                
                                // Reset styles
                                chatPanel.style.height = '';
                                chatPanel.style.maxHeight = '';
                                
                                const chatHistory = document.getElementById('chat-history');
                                if (chatHistory) {
                                    chatHistory.style.height = '60vh';
                                    chatHistory.style.maxHeight = '';
                                }
                            }
                            
                            fullscreenOverlay.style.display = 'none';
                            document.body.style.overflow = 'auto';
                            
                            // Update button text
                            const icon = fullscreenBtn.querySelector('i');
                            if (icon) icon.className = 'fas fa-expand';
                            fullscreenBtn.textContent = '';
                            fullscreenBtn.appendChild(icon || document.createElement('i').classList.add('fas', 'fa-expand'));
                            fullscreenBtn.appendChild(document.createTextNode(' Fullscreen'));
                            
                        } else {
                            console.log(' Entering fullscreen mode directly');
                            
                            // Move the chat panel
                            const chatPanel = fullscreenBtn.closest('.card');
                            if (chatPanel) {
                                // Store original parent for later restoration
                                window._originalContainer = chatPanel.parentElement;
                                
                                fullscreenOverlay.appendChild(chatPanel);
                                
                                // Set fullscreen styles
                                chatPanel.style.height = '100vh';
                                chatPanel.style.maxHeight = '100vh';
                                
                                const chatHistory = document.getElementById('chat-history');
                                if (chatHistory) {
                                    chatHistory.style.height = 'calc(100vh - 200px)';
                                    chatHistory.style.maxHeight = 'calc(100vh - 290px)';
                                }
                            } else {
                                console.error(' Chat panel not found');
                                return;
                            }
                            
                            fullscreenOverlay.style.display = 'flex';
                            document.body.style.overflow = 'hidden';
                            
                            // Update button text
                            const icon = fullscreenBtn.querySelector('i');
                            if (icon) icon.className = 'fas fa-compress';
                            fullscreenBtn.textContent = '';
                            fullscreenBtn.appendChild(icon || document.createElement('i').classList.add('fas', 'fa-compress'));
                            fullscreenBtn.appendChild(document.createTextNode(' Exit Fullscreen'));
                        }
                    }
                    
                    return false;
                };
            } else {
                console.error(' Fullscreen button not found in DOM');
            }
            
            if (fullscreenOverlay) {
                console.log(' Fullscreen overlay found');
                console.log(' Overlay properties:', {
                    id: fullscreenOverlay.id,
                    classList: fullscreenOverlay.className,
                    style: fullscreenOverlay.getAttribute('style'),
                    computedDisplay: window.getComputedStyle(fullscreenOverlay).display
                });
            } else {
                console.error(' Fullscreen overlay not found in DOM');
            }
        });
    </script>
</body>
</html> 